<!DOCTYPE html><html><head><meta charset="utf-8"><title>RestTemplate | my own space</title><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="description" content="最近做一个关于设计个人博客的项目实训，其中需要实现上传照片功能，思考再三，觉得保存在本地着实很 low，于是选择上传到第三方图床。接下来的问题很明确，如何调用第三方接口，首先想到的是大名鼎鼎的 HTTPClient，但 Spring 封装了库，提供了更为简洁的资源请求方式 RestTemplate。API 接口查看第三方图床 API 文档，上传图片为 POST 方法，参数暂时只需 File。请求"><meta name="keywords" content="Spring,RestTemplate"><meta property="og:type" content="article"><meta property="og:title" content="RestTemplate"><meta property="og:url" content="https://Kasper4649.github.io/2019/01/28/RestTemplate/index.html"><meta property="og:site_name" content="my own space"><meta property="og:description" content="最近做一个关于设计个人博客的项目实训，其中需要实现上传照片功能，思考再三，觉得保存在本地着实很 low，于是选择上传到第三方图床。接下来的问题很明确，如何调用第三方接口，首先想到的是大名鼎鼎的 HTTPClient，但 Spring 封装了库，提供了更为简洁的资源请求方式 RestTemplate。API 接口查看第三方图床 API 文档，上传图片为 POST 方法，参数暂时只需 File。请求"><meta property="og:locale" content="zh-Hans"><meta property="og:image" content="https://i.loli.net/2019/01/30/5c51bf30ee1ad.png"><meta property="og:image" content="https://i.loli.net/2019/01/30/5c51c0f78e7a1.png"><meta property="og:image" content="https://i.loli.net/2019/01/30/5c51bf30c44f6.png"><meta property="og:image" content="https://i.loli.net/2019/01/30/5c51bf31909d5.png"><meta property="og:updated_time" content="2019-02-21T06:53:12.526Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="RestTemplate"><meta name="twitter:description" content="最近做一个关于设计个人博客的项目实训，其中需要实现上传照片功能，思考再三，觉得保存在本地着实很 low，于是选择上传到第三方图床。接下来的问题很明确，如何调用第三方接口，首先想到的是大名鼎鼎的 HTTPClient，但 Spring 封装了库，提供了更为简洁的资源请求方式 RestTemplate。API 接口查看第三方图床 API 文档，上传图片为 POST 方法，参数暂时只需 File。请求"><meta name="twitter:image" content="https://i.loli.net/2019/01/30/5c51bf30ee1ad.png"><link rel="icon" href="/favicon.png"><link href="https://fonts.googleapis.com/css?family=Lato:400,400i,700" rel="stylesheet"><link rel="stylesheet" href="/icomoon/style.css"><link rel="stylesheet" href="/style.css"></head><body><div class="site-wrapper"><div id="loading-bar-wrapper"><div id="loading-bar"></div></div><script>document.getElementById("loading-bar").style.width="20%"</script><header id="header" class="site-header clearfix"><a class="logo square clearfix" href="/"><span class="b">m </span><span class="w">y </span><span class="b"></span> <span class="b">o </span><span class="b">w </span><span class="b">n </span><span class="b"></span> <span class="w">s </span><span class="b">p </span><span class="w">a </span><span class="b">c </span><span class="b">e </span></a><a class="me square site-nav-switch clearfix"><span class="b"><span class="icon icon-menu"></span></span></a></header><script>document.getElementById("loading-bar").style.width="40%"</script><main id="main" class="clearfix"><article id="post-RestTemplate" class="article white-box article-type-post" itemscope itemprop="blogPost"><header class="article-header"><h1 class="article-title" itemprop="name">RestTemplate</h1><div class="article-meta">Posted on <time class="article-time" datetime="2019-01-28T14:25:42.000Z" itemprop="datePublished">Jan 28, 2019</time></div></header><div class="article-entry" itemprop="articleBody"><p>最近做一个关于设计个人博客的项目实训，其中需要实现上传照片功能，思考再三，觉得保存在本地着实很 low，于是选择上传到第三方图床。接下来的问题很明确，如何调用第三方接口，首先想到的是大名鼎鼎的 HTTPClient，但 Spring 封装了库，提供了更为简洁的资源请求方式 RestTemplate。</p><h3 id="API-接口"><a href="#API-接口" class="headerlink" title="API 接口"></a>API 接口</h3><p>查看第三方图床 API 文档，上传图片为 POST 方法，参数暂时只需 File。<br><img src="https://i.loli.net/2019/01/30/5c51bf30ee1ad.png" alt="API"><br><img src="https://i.loli.net/2019/01/30/5c51c0f78e7a1.png" alt="API"></p><h4 id="请求-API"><a href="#请求-API" class="headerlink" title="请求 API"></a>请求 API</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">private String uploadViaSmms(MultipartFile file) &#123;</span><br><span class="line"></span><br><span class="line">    // 支持中文</span><br><span class="line">    restTemplate.getMessageConverters().set(1, new StringHttpMessageConverter(StandardCharsets.UTF_8));</span><br><span class="line"></span><br><span class="line">    String requestUrl = &quot;https://sm.ms/api/upload&quot;;</span><br><span class="line"></span><br><span class="line">    MultiValueMap&lt;String, Object&gt; postParameters = new LinkedMultiValueMap&lt;&gt;();</span><br><span class="line">    postParameters.add(&quot;smfile&quot;, file.getResource());</span><br><span class="line"></span><br><span class="line">    HttpHeaders headers = new HttpHeaders();</span><br><span class="line">    headers.setContentType(MediaType.MULTIPART_FORM_DATA);</span><br><span class="line">    headers.setAccept(Arrays.asList(MediaType.APPLICATION_JSON));</span><br><span class="line">    headers.add(&quot;user-agent&quot;, &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/54.0.2840.99 Safari/537.36&quot;);</span><br><span class="line"></span><br><span class="line">    HttpEntity&lt;MultiValueMap&lt;String, Object&gt;&gt; requestEntity = new HttpEntity&lt;&gt;(postParameters, headers);</span><br><span class="line">    ResponseEntity&lt;String&gt; response = restTemplate.postForEntity(requestUrl, requestEntity, String.class);</span><br><span class="line"></span><br><span class="line">    return response.getBody();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="处理-JSON-数据"><a href="#处理-JSON-数据" class="headerlink" title="处理 JSON 数据"></a>处理 JSON 数据</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">      Result r = new Result();</span><br><span class="line">      String result = uploadViaSmms(file);</span><br><span class="line"></span><br><span class="line">      JsonObject jsonObject = new JsonParser().parse(result).getAsJsonObject();</span><br><span class="line">      String code = jsonObject.get(&quot;code&quot;).getAsString();</span><br><span class="line">      if(!code.equals(&quot;success&quot;)) &#123;</span><br><span class="line">          r.setResultCode(ResultCode.UPLOAD_ERROR);</span><br><span class="line">          return r;</span><br><span class="line">      &#125;</span><br><span class="line">      String url = jsonObject.get(&quot;data&quot;).getAsJsonObject().get(&quot;url&quot;).getAsString();</span><br><span class="line">      String deleteUrl = jsonObject.get(&quot;data&quot;).getAsJsonObject().get(&quot;delete&quot;).getAsString();</span><br><span class="line"></span><br><span class="line">imageService.upload(url, deleteUrl, description);</span><br><span class="line">      r.setResultCode(ResultCode.SUCCESS);</span><br><span class="line"></span><br><span class="line">      return r;</span><br></pre></td></tr></table></figure><h3 id="需要注意的问题"><a href="#需要注意的问题" class="headerlink" title="需要注意的问题"></a>需要注意的问题</h3><ul><li>如果 headers 不添加 user-agent，则会报 <strong>403 Forbidden</strong>，也算一种常见的反爬措施。<br><img src="https://i.loli.net/2019/01/30/5c51bf30c44f6.png" alt="TIM截图20190128153446.png"></li><li>file 类型必须是可序列化元素，只能使用<code>file.getResource()</code>，不能使用<code>file.getBytes()</code>或<code>file.getInputStream()</code>，否则会报 <strong>No serializer found</strong>。<br><img src="https://i.loli.net/2019/01/30/5c51bf31909d5.png" alt="TIM截图20190128153853.png"><br><del>↑这个问题困扰了我两天，晚上 4 点都睡不着都是因为这，コノヤロー！</del></li></ul><h3 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h3><ol><li><a href="https://stackoverflow.com/questions/44922261/why-do-i-always-get-403-when-fetching-data-with-resttemplate" target="_blank" rel="noopener">403 Forbidden</a></li><li><a href="https://stackoverflow.com/questions/2591098/how-to-parse-json-in-java" target="_blank" rel="noopener">parse JSON</a></li></ol></div><div class="article-tags"><a class="tag-link" href="/tags/RestTemplate/">RestTemplate</a><a class="tag-link" href="/tags/Spring/">Spring</a></div><nav class="article-nav clearfix"><a href="/2019/04/13/996-ICU/" class="article-nav-newer"><div class="article-nav-title">996.ICU</div></a><a href="/2019/01/23/THE-GREATE-GATSBY/" class="article-nav-older"><div class="article-nav-title">THE GREATE GATSBY</div></a></nav></article><script>document.getElementById("loading-bar").style.width="60%"</script></main><footer id="footer" class="clearfix"><div class="search"><form name="searchform" id="searchform" class="u-search-form"><input type="text" id="searchinput" class="u-search-input st-default-search-input" data-list-highlight="true" data-list-value-completion="true" placeholder="Looking for something?"> <button type="submit" id="u-search-btn-submit" class="u-search-btn-submit"><span class="icon icon-search"></span></button></form></div><div>&copy; <a href="https://Kasper4649.github.io">my own space</a> Theme by <a href="http://artifact.me/" target="_blank">Art Chen</a>.</div><div>Powered by <a href="https://hexo.io/" rel="external">Hexo</a>.</div></footer><script>document.getElementById("loading-bar").style.width="80%"</script><div class="overlay"></div></div><div class="site-sidebar"><div class="sidebar-switch clearfix show" style="display:block"><a class="dark-btn active" data-toggle="toc"><span class="icon icon-list"></span> <span class="text">Index</span> </a><a class="dark-btn" data-toggle="bio"><span class="icon icon-person"></span> <span class="text">Bio</span></a></div><div class="site-toc show" style="display:block"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#API-接口"><span class="toc-number">1.</span> <span class="toc-text">API 接口</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#请求-API"><span class="toc-number">1.1.</span> <span class="toc-text">请求 API</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#处理-JSON-数据"><span class="toc-number">1.2.</span> <span class="toc-text">处理 JSON 数据</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#需要注意的问题"><span class="toc-number">2.</span> <span class="toc-text">需要注意的问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#参考资料"><span class="toc-number">3.</span> <span class="toc-text">参考资料</span></a></li></ol></div><div class="site-bio" style="display:none"><div class="about-me clearfix"><div class="avatar"><img src="/img/avatar.png"></div><div class="info"><a class="name dark-btn" href="/about">Kasper</a></div><div class="info"><span class="item desc">Eat the frog.</span></div></div><div class="social clearfix"><a href="/atom.xml" class="feed" target="_blank" rel="external"><span class="icon icon-feed"></span> </a><a href="https://github.com/Kasper4649" class="github" target="_blank" rel="external"><span class="icon icon-github"></span> </a><a href="https://twitter.com/__eisuke" class="twitter" target="_blank" rel="external"><span class="icon icon-twitter"></span> </a><a href="https://weibo.com/p/1005055337291720/home?from=page_100505&amp;mod=TAB&amp;is_all=1#place" class="weibo" target="_blank" rel="external"><span class="icon icon-weibo"></span></a></div><div class="shortcuts clearfix"><div class="bk"><a href="#header" class="dark-btn window-nav"><span class="icon icon-chevron-thin-up"></span> <span class="text">Back to Top</span></a></div><div class="bk"><a href="#footer" class="dark-btn window-nav"><span class="icon icon-chevron-thin-down"></span> <span class="text">Go to Bottom</span></a></div></div></div></div><script type="text/javascript">var GOOGLE_CUSTOM_SEARCH_API_KEY="",GOOGLE_CUSTOM_SEARCH_ENGINE_ID="",ALGOLIA_API_KEY="23360d4fd27b56673b85b7b836e2043d",ALGOLIA_APP_ID="K87DWETKQN",ALGOLIA_INDEX_NAME="blog",AZURE_SERVICE_NAME="",AZURE_INDEX_NAME="",AZURE_QUERY_KEY="",BAIDU_API_ID="",SEARCH_SERVICE="algolia"</script><script src="https://code.jquery.com/jquery-2.1.4.min.js"></script><script>window.jQuery||document.write('<script src="/js/jquery.js"><\/script>')</script><script src="/js/search.js"></script><script src="/js/app.js"></script><script>document.getElementById("loading-bar").style.width="100%"</script></body></html>